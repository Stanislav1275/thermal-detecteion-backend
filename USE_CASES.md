# Use-Case-ы проекта: Система детекции людей на тепловизионных изображениях

## Обзор системы

Система предназначена для автоматической детекции людей на тепловизионных изображениях с использованием модели YOLOv8, обученной на датасете FLIR ADAS. Система предоставляет REST API для пакетной обработки изображений и возвращает координаты обнаруженных людей с уровнем уверенности.

---

## 1. Use-Case: Мониторинг периметра объекта в темное время суток

### Описание
Оператор службы безопасности загружает тепловизионные изображения с камер периметра для автоматического обнаружения людей в условиях плохой видимости.

### Актеры
- Оператор службы безопасности
- Система детекции

### Предусловия
- Backend API запущен и модель загружена
- Оператор имеет доступ к тепловизионным изображениям с камер

### Основной поток событий
1. Оператор получает набор тепловизионных изображений с камер периметра за последний час
2. Оператор загружает изображения через API:
   ```bash
   curl -X POST "http://localhost:8000/api/upload" \
     -F "files=@camera1_23-00.jpg" \
     -F "files=@camera2_23-15.jpg" \
     -F "files=@camera3_23-30.jpg" \
     -F "confidence_threshold=0.6"
   ```
3. Система возвращает `job_id` и начинает асинхронную обработку
4. Оператор периодически проверяет статус задачи:
   ```bash
   curl "http://localhost:8000/api/jobs/{job_id}"
   ```
5. После завершения обработки оператор получает результаты:
   ```bash
   curl "http://localhost:8000/api/jobs/{job_id}/results"
   ```
6. Система возвращает список изображений с обнаруженными людьми:
   - Координаты bounding box для каждого человека
   - Уровень уверенности детекции
   - Количество обнаруженных людей на каждом изображении
7. Оператор просматривает обработанные изображения с визуализацией детекций
8. Оператор принимает решение о дальнейших действиях на основе результатов

### Постусловия
- Все изображения обработаны
- Результаты сохранены и доступны для просмотра
- Оператор получил информацию о наличии людей на периметре

### Альтернативные потоки
- **A1:** На изображениях не обнаружено людей
  - Система возвращает пустой список результатов
  - Оператор продолжает мониторинг
  
- **A2:** Ошибка обработки изображения
  - Система возвращает статус `failed` для конкретного изображения
  - Оператор может повторить загрузку проблемного изображения

---

## 2. Use-Case: Анализ архивных тепловизионных записей

### Описание
Аналитик безопасности анализирует архивные тепловизионные записи для поиска паттернов активности людей в определенные периоды времени.

### Актеры
- Аналитик безопасности
- Система детекции

### Предусловия
- Backend API запущен
- Аналитик имеет доступ к архиву тепловизионных изображений

### Основной поток событий
1. Аналитик выбирает период для анализа (например, все изображения за прошлую неделю)
2. Аналитик загружает пакет изображений (до нескольких сотен файлов):
   ```bash
   # Пакетная загрузка через скрипт
   python batch_upload.py --directory archive/week1/ --confidence 0.5
   ```
3. Система обрабатывает изображения асинхронно
4. Аналитик отслеживает прогресс обработки через API статуса
5. После завершения аналитик получает агрегированную статистику:
   - Общее количество изображений с людьми
   - Общее количество обнаруженных людей
   - Распределение по времени суток
   - Распределение по камерам
6. Аналитик скачивает обработанные изображения для визуального анализа
7. Аналитик формирует отчет на основе результатов

### Постусловия
- Архивные данные проанализированы
- Статистика доступна для дальнейшего анализа
- Обработанные изображения сохранены

---

## 3. Use-Case: Интеграция с системой видеонаблюдения

### Описание
Разработчик интегрирует систему детекции в существующую систему видеонаблюдения для автоматической обработки тепловизионных кадров в реальном времени.

### Актеры
- Разработчик системы видеонаблюдения
- Система детекции
- Система видеонаблюдения

### Предусловия
- Backend API развернут и доступен
- Система видеонаблюдения может отправлять HTTP-запросы

### Основной поток событий
1. Система видеонаблюдения получает новый кадр с тепловизионной камеры
2. Система видеонаблюдения автоматически отправляет кадр в API:
   ```python
   import requests
   
   with open('frame.jpg', 'rb') as f:
       response = requests.post(
           'http://detection-api:8000/api/upload',
           files={'files': f},
           data={'confidence_threshold': 0.5}
       )
   job_id = response.json()['job_id']
   ```
3. Система детекции обрабатывает кадр
4. Система видеонаблюдения периодически проверяет статус:
   ```python
   status = requests.get(f'http://detection-api:8000/api/jobs/{job_id}').json()
   ```
5. После завершения система видеонаблюдения получает результаты
6. Если обнаружены люди, система видеонаблюдения:
   - Сохраняет событие в журнал
   - Отправляет уведомление оператору
   - Запускает запись видео
   - Активирует дополнительные камеры (если доступны)

### Постусловия
- Кадр обработан
- Результаты интегрированы в систему видеонаблюдения
- При необходимости выполнены автоматические действия

### Альтернативные потоки
- **A1:** API недоступен
  - Система видеонаблюдения сохраняет кадр для повторной обработки
  - Логируется ошибка подключения

---

## 4. Use-Case: Проверка качества модели на новых данных

### Описание
ML-инженер проверяет качество обученной модели на новом наборе тепловизионных изображений перед развертыванием в production.

### Актеры
- ML-инженер
- Система детекции

### Предусловия
- Модель обучена и валидирована
- ML-инженер имеет тестовый набор изображений с ground truth аннотациями

### Основной поток событий
1. ML-инженер подготавливает тестовый набор изображений
2. ML-инженер загружает изображения через API с различными порогами уверенности:
   ```bash
   # Тест с разными порогами
   for conf in 0.3 0.5 0.7; do
     curl -X POST "http://localhost:8000/api/upload" \
       -F "files=@test_set.zip" \
       -F "confidence_threshold=$conf"
   done
   ```
3. ML-инженер получает результаты для каждого порога
4. ML-инженер сравнивает результаты с ground truth аннотациями
5. ML-инженер вычисляет метрики:
   - Precision (точность)
   - Recall (полнота)
   - F1-score
   - Количество ложных срабатываний
   - Количество пропущенных детекций
6. ML-инженер принимает решение о готовности модели к production

### Постусловия
- Качество модели оценено
- Метрики зафиксированы
- Принято решение о развертывании или дообучении

---

## 5. Use-Case: Обучение и валидация модели

### Описание
ML-исследователь обучает модель YOLOv8 на датасете FLIR ADAS и валидирует её качество.

### Актеры
- ML-исследователь
- Система обучения

### Предусловия
- Установлены зависимости (PyTorch, Ultralytics)
- Доступен датасет FLIR ADAS

### Основной поток событий
1. ML-исследователь подготавливает датасет:
   ```bash
   cd training
   python prepare_dataset.py --dataset-root /path/to/flir --output-root ./datasets/yolo
   ```
2. ML-исследователь запускает обучение:
   ```bash
   python train.py --data thermal.yaml --model n --epochs 100 --batch 16 --imgsz 416
   ```
3. Система обучает модель в течение нескольких часов
4. После обучения система автоматически сохраняет лучшую модель
5. ML-исследователь запускает валидацию:
   ```bash
   bash post_training.sh
   ```
6. Система валидирует модель на тестовом наборе и выводит метрики:
   - mAP@50
   - mAP@50-95
   - Precision
   - Recall
7. ML-исследователь анализирует метрики и визуализации
8. Если метрики удовлетворительны, модель готова к использованию

### Постусловия
- Модель обучена и валидирована
- Метрики качества зафиксированы
- Модель сохранена и готова к развертыванию

### Альтернативные потоки
- **A1:** Метрики неудовлетворительны
  - ML-исследователь корректирует гиперпараметры
  - Повторяет обучение с новыми параметрами

---

## 6. Use-Case: Мониторинг пожарной безопасности

### Описание
Специалист по пожарной безопасности использует систему для обнаружения людей в зонах повышенного риска на тепловизионных изображениях, полученных во время пожарных учений или реальных инцидентов.

### Актеры
- Специалист по пожарной безопасности
- Система детекции

### Предусловия
- Backend API запущен
- Доступны тепловизионные изображения с пожарных камер или дронов

### Основной поток событий
1. Специалист получает тепловизионные изображения с пожарных камер
2. Специалист загружает изображения с высоким порогом уверенности (0.7) для минимизации ложных срабатываний:
   ```bash
   curl -X POST "http://localhost:8000/api/upload" \
     -F "files=@fire_zone_1.jpg" \
     -F "files=@fire_zone_2.jpg" \
     -F "confidence_threshold=0.7"
   ```
3. Система обрабатывает изображения
4. Специалист получает результаты с координатами обнаруженных людей
5. Специалист использует координаты для:
   - Планирования эвакуации
   - Направления спасательных команд
   - Оценки количества людей в зоне риска
6. Специалист сохраняет результаты для отчетности

### Постусловия
- Изображения проанализированы
- Координаты людей определены
- Результаты использованы для принятия решений

---

## 7. Use-Case: Разработка и тестирование API

### Описание
Разработчик тестирует API перед развертыванием, проверяя все endpoints и обработку различных сценариев.

### Актеры
- Разработчик
- Система детекции

### Предусловия
- Backend API запущен локально
- Разработчик имеет тестовые изображения

### Основной поток событий
1. Разработчик проверяет здоровье API:
   ```bash
   curl "http://localhost:8000/health"
   ```
2. Разработчик проверяет загрузку одного изображения
3. Разработчик проверяет загрузку нескольких изображений
4. Разработчик проверяет обработку различных форматов (TIFF, PNG, JPEG)
5. Разработчик проверяет обработку ошибок:
   - Неподдерживаемый формат
   - Поврежденное изображение
   - Отсутствие модели
6. Разработчик проверяет получение результатов
7. Разработчик проверяет получение обработанных изображений
8. Разработчик использует Swagger UI для интерактивного тестирования:
   ```
   http://localhost:8000/docs
   ```

### Постусловия
- API протестировано
- Все endpoints работают корректно
- Обработка ошибок проверена

---

## Общие характеристики системы

### Производительность
- **Пакетная обработка:** Поддержка одновременной обработки множества изображений
- **Асинхронность:** Обработка выполняется в фоновом режиме, не блокируя API
- **Масштабируемость:** Система может обрабатывать от единиц до сотен изображений за задачу

### Надежность
- **Обработка ошибок:** Система корректно обрабатывает ошибки и возвращает статусы
- **Валидация входных данных:** Проверка форматов изображений перед обработкой
- **Мониторинг:** Endpoint `/health` для проверки состояния системы

### Безопасность
- **Локальное хранение:** Результаты хранятся локально, без передачи в облако
- **Временное хранение:** Результаты сохраняются временно в директории `jobs/`
- **CORS:** Настроен для работы с веб-приложениями

### Удобство использования
- **REST API:** Стандартный REST API для интеграции
- **Swagger UI:** Интерактивная документация API
- **JSON ответы:** Структурированные JSON ответы с метаданными
- **Визуализация:** Возможность получения обработанных изображений с bounding boxes

---

## Технические ограничения

1. **Форматы изображений:** Поддерживаются TIFF, PNG, JPEG, WEBP
2. **Размер модели:** YOLOv8n (~6 MB) оптимизирован для быстрой инференции
3. **Устройства:** Поддержка MPS (Apple Silicon), CUDA (NVIDIA), CPU
4. **Хранение:** Результаты хранятся временно, требуют периодической очистки
5. **Порог уверенности:** Настраивается от 0.0 до 1.0, рекомендуется 0.5-0.7

---

## Метрики успеха use-case-ов

- **Точность детекции:** mAP@50 ≥ 0.70
- **Скорость обработки:** Обработка одного изображения < 1 секунды
- **Надежность API:** Доступность ≥ 99%
- **Удобство интеграции:** Время интеграции < 1 часа для разработчика

