"""
–û–±—É—á–µ–Ω–∏–µ YOLOv8n –º–æ–¥–µ–ª–∏ –Ω–∞ —Ç–µ—Ä–º–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö FLIR ADAS.
"""

import os
from pathlib import Path
from ultralytics import YOLO
import torch


def train_thermal_model(
    data_yaml: str = "thermal.yaml",
    model_size: str = "n",  # n, s, m, l, x
    epochs: int = 100,
    imgsz: int = 640,
    batch: int = 16,
    device: str = None,
    project: str = "training/runs",
    name: str = "thermal_detection",
    **kwargs
):
    """
    –û–±—É—á–∞–µ—Ç YOLOv8 –º–æ–¥–µ–ª—å –Ω–∞ —Ç–µ—Ä–º–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
    
    –ü—Ä–æ—Ü–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è:
    1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (MPS/CUDA/CPU)
    2. –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–æ–±—É—á–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ YOLOv8
    3. –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ YAML –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    4. –û–±—É—á–µ–Ω–∏–µ —Å –∞—É–≥–º–µ–Ω—Ç–∞—Ü–∏–µ–π, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–ª—è —Ç–µ—Ä–º–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    5. –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —ç–ø–æ—Ö–∏
    6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏ –ø–æ –º–µ—Ç—Ä–∏–∫–µ mAP@50
    
    Args:
        data_yaml: –ü—É—Ç—å –∫ YAML —Ñ–∞–π–ª—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–∞—Ç–∞—Å–µ—Ç–∞
        model_size: –†–∞–∑–º–µ—Ä –º–æ–¥–µ–ª–∏ ('n', 's', 'm', 'l', 'x')
        epochs: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ø–æ—Ö –æ–±—É—á–µ–Ω–∏—è
        imgsz: –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
        batch: –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞
        device: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è ('cpu', 'mps', 'cuda', –∏–ª–∏ None –¥–ª—è –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è)
        project: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        name: –ò–º—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
        **kwargs: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—É—á–µ–Ω–∏—è
    """
    # –≠—Ç–∞–ø 1: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
    # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: MPS (Apple Silicon) > CUDA (NVIDIA) > CPU
    if device is None:
        if torch.backends.mps.is_available():
            device = "mps"
            print("‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è MPS (Apple Silicon)")
        elif torch.cuda.is_available():
            device = "cuda"
            print("‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è CUDA")
        else:
            device = "cpu"
            print("‚ö† –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è CPU")
    
    # –≠—Ç–∞–ø 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–∞—Ç–∞—Å–µ—Ç–∞
    if not os.path.exists(data_yaml):
        raise FileNotFoundError(f"–§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω: {data_yaml}")
    
    # –≠—Ç–∞–ø 3: –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–æ–±—É—á–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ YOLOv8
    # –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å –≤–µ—Å–∞–º–∏, –ø—Ä–µ–¥–æ–±—É—á–µ–Ω–Ω—ã–º–∏ –Ω–∞ COCO –¥–∞—Ç–∞—Å–µ—Ç–µ
    # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å transfer learning –¥–ª—è —Ç–µ—Ä–º–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    model_name = f"yolov8{model_size}.pt"
    print(f"\nüì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏: {model_name}")
    model = YOLO(model_name)
    
    # –≠—Ç–∞–ø 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –æ–±—É—á–µ–Ω–∏—è
    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è —Ç–µ—Ä–º–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
    # - –ê—É–≥–º–µ–Ω—Ç–∞—Ü–∏—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–≤—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (—Ç–µ—Ä–º–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–æ–Ω–æ—Ö—Ä–æ–º–Ω—ã–µ)
    # - –ù–µ–±–æ–ª—å—à–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —è—Ä–∫–æ—Å—Ç–∏ –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π —Å—ä–µ–º–∫–∏
    # - Mosaic –∏ Mixup –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è –¥–∞–Ω–Ω—ã—Ö
    train_params = {
        "data": data_yaml,  # –ü—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–∞—Ç–∞—Å–µ—Ç–∞
        "epochs": epochs,
        "imgsz": imgsz,  # –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (640x640)
        "batch": batch,
        "device": device,
        "project": project,  # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        "name": name,  # –ò–º—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
        "patience": 10,  # Early stopping: –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —É–ª—É—á—à–µ–Ω–∏–π
        "save": True,
        "save_period": 10,  # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ–∫–ø–æ–∏–Ω—Ç–∞ –∫–∞–∂–¥—ã–µ 10 —ç–ø–æ—Ö
        "val": True,  # –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —ç–ø–æ—Ö–∏
        "plots": True,  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –º–µ—Ç—Ä–∏–∫
        "verbose": True,
        # –ê—É–≥–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è —Ç–µ—Ä–º–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        "degrees": 5,  # –ù–µ–±–æ–ª—å—à–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ (¬±5 –≥—Ä–∞–¥—É—Å–æ–≤)
        "scale": 0.2,  # –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ ¬±20%
        "shear": 1,  # –ù–µ–±–æ–ª—å—à–æ–π —Å–¥–≤–∏–≥
        "perspective": 0,  # –ë–µ–∑ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã—Ö –∏—Å–∫–∞–∂–µ–Ω–∏–π (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏)
        "flipud": 0,  # –ë–µ–∑ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –æ—Ç—Ä–∞–∂–µ–Ω–∏—è (–ª—é–¥–∏ –æ–±—ã—á–Ω–æ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏)
        "hsv_h": 0,  # –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç—Ç–µ–Ω–∫–∞ (—Ç–µ—Ä–º–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–æ–Ω–æ—Ö—Ä–æ–º–Ω—ã–µ)
        "hsv_s": 0,  # –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç–∏
        "hsv_v": 0.1,  # –ù–µ–±–æ–ª—å—à–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —è—Ä–∫–æ—Å—Ç–∏ (¬±10%) –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π
        "mosaic": 0.5,  # Mosaic –∞—É–≥–º–µ–Ω—Ç–∞—Ü–∏—è (50% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
        "mixup": 0.05,  # Mixup –∞—É–≥–º–µ–Ω—Ç–∞—Ü–∏—è (5% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞ (SGD)
        "lr0": 0.001,  # –ù–∞—á–∞–ª—å–Ω—ã–π learning rate
        "lrf": 0.1,  # –§–∏–Ω–∞–ª—å–Ω—ã–π learning rate = lr0 * lrf (cosine annealing)
        "momentum": 0.937,  # Momentum –¥–ª—è SGD
        "weight_decay": 0.0005,  # L2 —Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è
        "warmup_epochs": 3,  # Warmup: –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ learning rate
        "warmup_momentum": 0.8,  # Momentum –≤–æ –≤—Ä–µ–º—è warmup
        "warmup_bias_lr": 0.1,  # Learning rate –¥–ª—è bias –≤–æ –≤—Ä–µ–º—è warmup
    }
    
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ kwargs
    train_params.update(kwargs)
    
    print(f"\nüöÄ –ù–∞—á–∞–ª–æ –æ–±—É—á–µ–Ω–∏—è:")
    print(f"   - –ú–æ–¥–µ–ª—å: YOLOv8{model_size}")
    print(f"   - –≠–ø–æ—Ö–∏: {epochs}")
    print(f"   - –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {imgsz}")
    print(f"   - –ë–∞—Ç—á: {batch}")
    print(f"   - –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: {device}")
    print(f"   - –î–∞—Ç–∞—Å–µ—Ç: {data_yaml}")
    
    # –≠—Ç–∞–ø 5: –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
    # –ü—Ä–æ—Ü–µ—Å—Å –≤–∫–ª—é—á–∞–µ—Ç:
    # - –ó–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö –∏–∑ –¥–∞—Ç–∞—Å–µ—Ç–∞
    # - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∞—É–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ –∫ –∫–∞–∂–¥–æ–º—É –±–∞—Ç—á—É
    # - Forward pass —á–µ—Ä–µ–∑ –º–æ–¥–µ–ª—å
    # - –í—ã—á–∏—Å–ª–µ–Ω–∏–µ loss (classification + localization)
    # - Backward pass –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Å–æ–≤
    # - –í–∞–ª–∏–¥–∞—Ü–∏—é –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —ç–ø–æ—Ö–∏
    # - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏ –ø–æ mAP@50
    results = model.train(**train_params)
    
    # –≠—Ç–∞–ø 6: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –º–µ—Å—Ç–æ
    # –õ—É—á—à–∞—è –º–æ–¥–µ–ª—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –º–µ—Ç—Ä–∏–∫–µ mAP@50 –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω–æ–º –Ω–∞–±–æ—Ä–µ
    best_model_path = os.path.join(project, name, "weights", "best.pt")
    if os.path.exists(best_model_path):
        target_path = "training/models/best.pt"
        os.makedirs(os.path.dirname(target_path), exist_ok=True)
        import shutil
        shutil.copy(best_model_path, target_path)
        print(f"\n‚úÖ –õ—É—á—à–∞—è –º–æ–¥–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {target_path}")
    
    print(f"\n‚úÖ –û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
    print(f"   - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: {os.path.join(project, name)}")
    
    return results, model


if __name__ == "__main__":
    import argparse
    
    parser = argparse.ArgumentParser(description='–û–±—É—á–µ–Ω–∏–µ YOLOv8 –Ω–∞ —Ç–µ—Ä–º–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö')
    parser.add_argument(
        '--data',
        type=str,
        default='thermal.yaml',
        help='–ü—É—Ç—å –∫ YAML —Ñ–∞–π–ª—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–∞—Ç–∞—Å–µ—Ç–∞'
    )
    parser.add_argument(
        '--model',
        type=str,
        default='n',
        choices=['n', 's', 'm', 'l', 'x'],
        help='–†–∞–∑–º–µ—Ä –º–æ–¥–µ–ª–∏ (n=nano, s=small, m=medium, l=large, x=xlarge)'
    )
    parser.add_argument(
        '--epochs',
        type=int,
        default=100,
        help='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ø–æ—Ö –æ–±—É—á–µ–Ω–∏—è'
    )
    parser.add_argument(
        '--imgsz',
        type=int,
        default=640,
        help='–†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π'
    )
    parser.add_argument(
        '--batch',
        type=int,
        default=16,
        help='–†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞'
    )
    parser.add_argument(
        '--device',
        type=str,
        default=None,
        help='–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (cpu, mps, cuda) –∏–ª–∏ None –¥–ª—è –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è'
    )
    
    args = parser.parse_args()
    
    train_thermal_model(
        data_yaml=args.data,
        model_size=args.model,
        epochs=args.epochs,
        imgsz=args.imgsz,
        batch=args.batch,
        device=args.device
    )

